<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalPro - Gesti√≥n de Taller</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">

    <nav class="bg-black p-4 text-center border-b border-yellow-500">
        <h1 class="text-xl font-bold tracking-widest text-yellow-500">GLOBAL PRO AUTOMOTRIZ</h1>
    </nav>

    <div class="max-w-md mx-auto p-6">
        <div class="flex mb-6 bg-gray-800 rounded-lg overflow-hidden border border-gray-700">
            <button onclick="switchTab('registrar')" id="tab-registrar" class="w-1/2 py-3 bg-yellow-500 text-black font-bold">REGISTRAR</button>
            <button onclick="switchTab('historial')" id="tab-historial" class="w-1/2 py-3 hover:bg-gray-700">HISTORIAL</button>
        </div>

        <div id="section-registrar" class="space-y-4">
            <input type="text" id="nombre_usuario" placeholder="Nombre del Cliente" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none">
            <input type="text" id="telefono" placeholder="Tel√©fono" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none">
            <input type="text" id="placa" placeholder="Placa del Veh√≠culo (Ej: AE123BB)" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none">
            <input type="text" id="tecnico" placeholder="Nombre del T√©cnico" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none">
            <input type="number" id="km" placeholder="Kilometraje Actual" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none">
            <input type="text" id="aceite" placeholder="Tipo de Aceite Utilizado" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none">
            <textarea id="notas" placeholder="Notas de mantenimiento..." class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-yellow-500 outline-none h-24"></textarea>
            <button onclick="enviarEvento()" id="btn-guardar" class="w-full bg-yellow-500 text-black font-bold py-4 rounded hover:bg-yellow-400 transition shadow-lg">GUARDAR EN HISTORIAL</button>
        </div>

        <div id="section-historial" class="hidden space-y-4">
            <div class="flex space-x-2">
                <input type="text" id="busqueda" placeholder="Buscar por Placa o Tel√©fono" class="flex-1 p-3 bg-gray-800 border border-gray-700 rounded outline-none focus:border-yellow-500">
                <button onclick="buscarHistorial()" class="bg-gray-700 px-4 rounded hover:bg-gray-600">üîç</button>
            </div>
            <div id="resultado-historial" class="space-y-3">
                <p class="text-gray-500 text-center italic mt-4">Ingresa una placa para ver los servicios pasados.</p>
            </div>
        </div>
    </div>

    <script>
        // LA URL DEBE SER ABSOLUTA Y SIN COMILLAS EXTRAS
        const WORKER_URL = "https://taller.estilosgrado33.workers.dev";

        function switchTab(tab) {
            const isReg = tab === 'registrar';
            document.getElementById('section-registrar').classList.toggle('hidden', !isReg);
            document.getElementById('section-historial').classList.toggle('hidden', isReg);
            document.getElementById('tab-registrar').className = isReg ? 'w-1/2 py-3 bg-yellow-500 text-black font-bold' : 'w-1/2 py-3 hover:bg-gray-700';
            document.getElementById('tab-historial').className = !isReg ? 'w-1/2 py-3 bg-yellow-500 text-black font-bold' : 'w-1/2 py-3 hover:bg-gray-700';
        }

        async function enviarEvento() {
            const btn = document.getElementById('btn-guardar');
            const data = {
                nombre_usuario: document.getElementById('nombre_usuario').value,
                telefono: document.getElementById('telefono').value,
                placa: document.getElementById('placa').value,
                tecnico: document.getElementById('tecnico').value,
                km: document.getElementById('km').value,
                aceite: document.getElementById('aceite').value,
                notas: document.getElementById('notas').value
            };

            if (!data.placa) return alert("La placa es obligatoria");
            
            btn.innerText = "GUARDANDO...";
            btn.disabled = true;

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    mode: 'cors', // Forzamos modo CORS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("‚úÖ ¬°Servicio registrado con √©xito!");
                    location.reload();
                } else {
                    throw new Error("Error en servidor");
                }
            } catch (error) {
                console.error(error);
                alert("‚ùå Error de conexi√≥n: " + error.message);
            } finally {
                btn.innerText = "GUARDAR EN HISTORIAL";
                btn.disabled = false;
            }
        }

        async function buscarHistorial() {
            const query = document.getElementById('busqueda').value;
            const contenedor = document.getElementById('resultado-historial');
            if (!query) return;

            contenedor.innerHTML = "<p class='text-center'>Buscando...</p>";

            try {
                const response = await fetch(`${WORKER_URL}?buscar=${query}`);
                const data = await response.json();

                if (data.length === 0) {
                    contenedor.innerHTML = "<p class='text-center text-red-400'>No se encontraron registros.</p>";
                    return;
                }

                contenedor.innerHTML = data.map(ev => `
                    <div class="bg-gray-800 p-4 rounded border-l-4 border-yellow-500 shadow-md">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-yellow-500">${new Date(ev.fecha_hora).toLocaleDateString()}</span>
                            <span class="text-xs text-gray-400">KM: ${ev.kilometraje}</span>
                        </div>
                        <p class="text-sm"><strong>T√©cnico:</strong> ${ev.tecnico_nombre}</p>
                        <p class="text-sm"><strong>Aceite:</strong> ${ev.tipo_aceite}</p>
                        <p class="mt-2 text-gray-300 italic border-t border-gray-700 pt-2 text-xs">${ev.notas_exigibles || 'Sin notas'}</p>
                    </div>
                `).join('');

            } catch (error) {
                contenedor.innerHTML = "<p class='text-center text-red-500'>Error al buscar.</p>";
            }
        }
    </script>
</body>
</html>