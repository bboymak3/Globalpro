<div style="max-width: 900px; margin: auto; font-family: sans-serif; padding: 20px;">
    <h2>üìã Gesti√≥n de Citas</h2>
    
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button onclick="verCitas('ayer')" style="padding:10px; cursor:pointer;">Ayer</button>
        <button onclick="verCitas('hoy')" style="padding:10px; background:#007bff; color:white; border:none; cursor:pointer;">Hoy</button>
        <button onclick="verCitas('manana')" style="padding:10px; background:#28a745; color:white; border:none; cursor:pointer;">Ma√±ana</button>
        <button onclick="verCitas('mes')" style="padding:10px; cursor:pointer;">Mes</button>
        <button onclick="verCitas('todos')" style="padding:10px; cursor:pointer;">Todos</button>
    </div>

    <table border="1" style="width:100%; border-collapse: collapse; text-align: center;">
        <thead style="background:#eee;">
            <tr>
                <th>Fecha/Hora</th>
                <th>Placa</th>
                <th>WhatsApp</th>
                <th>Servicio</th>
                <th>Estado</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody id="cuerpoTablaCitas">
            </tbody>
    </table>
</div>

<script>
async function verCitas(periodo) {
    const cuerpo = document.getElementById('cuerpoTablaCitas');
    cuerpo.innerHTML = "<tr><td colspan='6'>Cargando...</td></tr>";

    try {
        const res = await fetch(`/api?periodo=${periodo}`);
        const datos = await res.json();
        cuerpo.innerHTML = "";

        if(datos.length === 0) {
            cuerpo.innerHTML = "<tr><td colspan='6'>No hay citas.</td></tr>";
            return;
        }

        datos.forEach(c => {
            const msj = `Hola! Global Pro te informa que tu cita para la placa ${c.placa} el dia ${c.fecha_cita} ha sido ACEPTADA. Te esperamos!`;
            const linkWA = `https://wa.me/${c.whatsapp}?text=${encodeURIComponent(msj)}`;
            
            cuerpo.innerHTML += `
                <tr>
                    <td>${c.fecha_cita}<br><small>${c.hora_cita}</small></td>
                    <td style="font-weight:bold;">${c.placa}</td>
                    <td><a href="https://wa.me/${c.whatsapp}" target="_blank">${c.whatsapp}</a></td>
                    <td>${c.servicio}</td>
                    <td style="font-weight:bold;">${c.estado}</td>
                    <td>
                        <button onclick="actualizarEstatus(${c.id}, 'Aceptada'); window.open('${linkWA}')" style="background:#28a745; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">‚úîÔ∏è Aceptar</button>
                        <button onclick="actualizarEstatus(${c.id}, 'Rechazada')" style="background:#dc3545; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">‚ùå</button>
                    </td>
                </tr>`;
        });
    } catch (e) {
        cuerpo.innerHTML = "<tr><td colspan='6'>Error de carga.</td></tr>";
    }
}

async function actualizarEstatus(id, nuevoEstado) {
    try {
        await fetch('/api', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, nuevoEstado })
        });
        alert("Estado actualizado a: " + nuevoEstado);
        location.reload(); // Recarga para ver el cambio
    } catch (e) {
        alert("Error al actualizar");
    }
}

document.addEventListener('DOMContentLoaded', () => verCitas('hoy'));
</script>
