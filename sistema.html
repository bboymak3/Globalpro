<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalPro Taller</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-4 font-sans">
    <div class="max-w-md mx-auto bg-slate-800 p-6 rounded-xl border-t-4 border-yellow-500 shadow-2xl">
        <h2 class="text-2xl font-black text-center text-yellow-500 mb-6 uppercase tracking-tighter">Global Pro Automotriz</h2>
        
        <input type="text" id="placa" placeholder="PLACA" class="w-full p-3 mb-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none uppercase">
        <input type="text" id="nombre" placeholder="Nombre del Cliente" class="w-full p-3 mb-3 bg-slate-700 rounded-lg outline-none">
        <input type="text" id="tecnico" placeholder="T√©cnico Encargado" class="w-full p-3 mb-3 bg-slate-700 rounded-lg outline-none">
        <input type="number" id="km" placeholder="Kilometraje" class="w-full p-3 mb-3 bg-slate-700 rounded-lg outline-none">
        <input type="text" id="aceite" placeholder="Tipo de Aceite" class="w-full p-3 mb-3 bg-slate-700 rounded-lg outline-none">
        <textarea id="notas" placeholder="Observaciones del servicio..." class="w-full p-3 mb-4 bg-slate-700 rounded-lg h-24 outline-none"></textarea>
        
        <button onclick="guardar()" id="btn" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl hover:bg-yellow-400 active:scale-95 transition">GUARDAR SERVICIO</button>
        
        <div class="mt-8 pt-6 border-t border-slate-700">
            <div class="flex gap-2">
                <input type="text" id="busqueda" placeholder="BUSCAR PLACA" class="flex-1 p-3 bg-slate-700 rounded-lg border border-slate-600 outline-none uppercase">
                <button onclick="buscar()" class="bg-slate-600 px-4 rounded-lg">üîç</button>
            </div>
            <div id="resultado" class="mt-4 space-y-3"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://taller.estilosgrado33.workers.dev";

        async function guardar() {
            const btn = document.getElementById('btn');
            const data = {
                placa: document.getElementById('placa').value,
                nombre_usuario: document.getElementById('nombre').value,
                tecnico: document.getElementById('tecnico').value,
                km: document.getElementById('km').value,
                aceite: document.getElementById('aceite').value,
                notas: document.getElementById('notas').value
            };

            if(!data.placa) return alert("La placa es obligatoria");
            btn.disabled = true; btn.innerText = "PROCESANDO...";

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if(res.ok) {
                    alert("‚úÖ ¬°Servicio guardado!");
                    location.reload();
                } else { throw new Error(); }
            } catch(e) { 
                alert("‚ùå Error de servidor. Revisa los Bindings."); 
            } finally { 
                btn.disabled = false; btn.innerText = "GUARDAR SERVICIO"; 
            }
        }

        async function buscar() {
            const q = document.getElementById('busqueda').value;
            const res = await fetch(`${API_URL}?buscar=${q}`);
            const data = await res.json();
            const cont = document.getElementById('resultado');
            
            cont.innerHTML = data.length ? data.map(ev => `
                <div class="bg-slate-900 p-4 rounded-lg border-l-4 border-yellow-500 text-sm shadow-md">
                    <p class="text-yellow-500 font-bold mb-1">${new Date(ev.fecha_hora).toLocaleDateString()}</p>
                    <p class="text-slate-300"><strong>KM:</strong> ${ev.kilometraje} | <strong>Aceite:</strong> ${ev.tipo_aceite}</p>
                    <p class="text-slate-500 text-xs mt-2 italic">${ev.notas_exigibles}</p>
                </div>
            `).join('') : "<p class='text-center text-slate-500'>Sin resultados</p>";
        }
    </script>

<div class="admin-agenda">
    <h2>üìã Agenda del Taller</h2>
    <div class="filtros">
        <button onclick="verCitas('hoy')">Hoy</button>
        <button onclick="verCitas('manana')">Ma√±ana</button>
        <button onclick="verCitas('mes')">Mes</button>
    </div>

    <table border="1" id="tablaCitas" style="width:100%; margin-top:20px; border-collapse: collapse;">
        <thead>
            <tr style="background:#333; color:white;">
                <th>Fecha</th>
                <th>Hora</th>
                <th>Placa</th>
                <th>Servicio</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla">
            </tbody>
    </table>
</div>

<script>
async function verCitas(periodo) {
    const cuerpo = document.getElementById('cuerpoTabla');
    cuerpo.innerHTML = "<tr><td colspan='4'>Buscando...</td></tr>";

    try {
        const res = await fetch(`/api?periodo=${periodo}`);
        const datos = await res.json();
        
        cuerpo.innerHTML = datos.map(c => `
            <tr>
                <td>${c.fecha_cita}</td>
                <td>${c.hora_cita}</td>
                <td><b>${c.placa}</b></td>
                <td>${c.servicio}</td>
            </tr>
        `).join('') || "<tr><td colspan='4'>No hay citas programadas.</td></tr>";
    } catch (err) {
        cuerpo.innerHTML = "<tr><td colspan='4'>Error al cargar.</td></tr>";
    }
}

// Cargar las de hoy autom√°ticamente al entrar
verCitas('hoy');
</script>

</body>
</html>