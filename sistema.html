<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Pro Automotriz - Gesti√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen">

    <nav class="bg-slate-800 p-4 border-b border-yellow-500 shadow-md">
        <h1 class="text-center text-2xl font-black tracking-tighter text-yellow-500 uppercase">
            Global Pro Automotriz
        </h1>
    </nav>

    <div class="max-w-md mx-auto p-6">
        
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700">
            <h2 class="text-lg font-bold mb-4 text-yellow-500 border-b border-slate-700 pb-2 uppercase text-xs tracking-widest">
                Registrar Nuevo Servicio
            </h2>
            
            <div class="space-y-3">
                <input type="text" id="placa" placeholder="PLACA (Obligatorio)" 
                    class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none uppercase font-bold text-yellow-400">
                
                <input type="text" id="nombre_usuario" placeholder="Nombre del Cliente" 
                    class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none">
                
                <input type="text" id="tecnico" placeholder="T√©cnico Encargado" 
                    class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none">
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="km" placeholder="Kilometraje" 
                        class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none">
                    <input type="text" id="aceite" placeholder="Tipo de Aceite" 
                        class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none">
                </div>

                <textarea id="notas" placeholder="Observaciones y detalles del servicio..." 
                    class="w-full p-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-yellow-500 outline-none h-24"></textarea>
                
                <button onclick="guardarServicio()" id="btn-guardar" 
                    class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl hover:bg-yellow-400 active:scale-95 transition shadow-lg uppercase tracking-wider">
                    Guardar en Historial
                </button>
            </div>
        </div>

        <div class="mt-8">
            <h2 class="text-yellow-500 font-bold mb-4 uppercase text-xs tracking-widest">Consulta de Historial</h2>
            <div class="flex gap-2">
                <input type="text" id="busqueda" placeholder="Ingrese Placa" 
                    class="flex-1 p-3 bg-slate-800 border border-slate-700 rounded-lg outline-none focus:border-yellow-500 uppercase font-bold">
                <button onclick="buscarHistorial()" class="bg-slate-700 px-6 rounded-lg hover:bg-slate-600 transition">üîç</button>
            </div>
            
            <div id="resultado-historial" class="mt-6 space-y-4">
                </div>
        </div>
    </div>

    <script>
        // URL de tu Worker de Cloudflare
        const API_URL = "https://taller.estilosgrado33.workers.dev";

        async function guardarServicio() {
            const btn = document.getElementById('btn-guardar');
            
            // Recolecci√≥n de datos asegurando que NADA sea undefined
            const data = {
                placa: (document.getElementById('placa').value || "").trim(),
                nombre_usuario: document.getElementById('nombre_usuario').value || "Cliente Particular",
                tecnico: document.getElementById('tecnico').value || "General",
                km: document.getElementById('km').value || 0,
                aceite: document.getElementById('aceite').value || "No especificado",
                notas: document.getElementById('notas').value || "Sin observaciones adicionales"
            };

            if (!data.placa) {
                alert("‚ö†Ô∏è Error: La placa es obligatoria para el registro.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "ENVIANDO DATOS...";

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert("‚úÖ ¬°Servicio guardado correctamente!");
                    location.reload(); // Recarga para limpiar el formulario
                } else {
                    alert("‚ùå Error: " + (result.error || "No se pudo guardar"));
                }
            } catch (error) {
                alert("‚ùå Error de red: No se pudo conectar con el servidor.");
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerText = "Guardar en Historial";
            }
        }

        async function buscarHistorial() {
            const query = document.getElementById('busqueda').value.trim();
            const contenedor = document.getElementById('resultado-historial');
            
            if (!query) return;

            contenedor.innerHTML = "<p class='text-center text-slate-500'>Buscando registros...</p>";

            try {
                const response = await fetch(`${API_URL}?buscar=${query}`);
                const data = await response.json();

                if (data.length === 0) {
                    contenedor.innerHTML = "<div class='bg-slate-800 p-4 rounded-lg text-center text-slate-400 border border-slate-700 italic'>No se encontraron mantenimientos para esta placa.</div>";
                    return;
                }

                contenedor.innerHTML = data.map(ev => `
                    <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-yellow-500 shadow-md border-y border-r border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-yellow-500 font-black">${new Date(ev.fecha_hora).toLocaleDateString()}</span>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">KM: ${ev.kilometraje}</span>
                        </div>
                        <div class="text-sm space-y-1">
                            <p><span class="text-slate-500">T√©cnico:</span> ${ev.tecnico_nombre}</p>
                            <p><span class="text-slate-500">Aceite:</span> ${ev.tipo_aceite}</p>
                            <div class="mt-3 p-2 bg-slate-900 rounded text-xs text-slate-400 italic border border-slate-700">
                                ${ev.notas_exigibles}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                contenedor.innerHTML = "<p class='text-center text-red-500 font-bold'>Error al consultar el historial.</p>";
            }
        }
    </script>
</body>
</html>