<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Sistema - Global Pro</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2, h3 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        /* Estilos Formulario OT */
        .form-group { margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-guardar { background: #007bff; color: white; padding: 12px; width: 100%; }
        .btn-guardar:hover { background: #0056b3; }

        /* Estilos Agenda */
        .filtros { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .btn-filtro { padding: 10px 15px; background: #6c757d; color: white; }
        .btn-hoy { background: #007bff; }
        .btn-manana { background: #28a745; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #333; color: white; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        .placa-resaltada { font-weight: bold; color: #d9534f; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ†Ô∏è Registro de Orden de Trabajo (OT)</h2>
    <form id="otForm">
        <div class="form-group">
            <input type="text" id="otPlaca" placeholder="PLACA (ej: RCM36H)" required>
        </div>
        <div class="form-group">
            <input type="number" id="otKm" placeholder="Kilometraje Actual" required>
        </div>
        <div class="form-group">
            <input type="text" id="otTecnico" placeholder="Nombre del T√©cnico" required>
        </div>
        <div class="form-group">
            <textarea id="otDetalles" rows="3" placeholder="Descripci√≥n del trabajo..." required></textarea>
        </div>
        <button type="submit" class="btn-guardar" id="btnGuardarOT">Guardar OT en Sistema</button>
    </form>
    <div id="otStatus" style="margin-top:10px; text-align:center;"></div>

    <hr style="margin: 40px 0;">

    <h2>üìã Agenda de Citas</h2>
    <div class="filtros">
        <button class="btn-filtro" onclick="verCitas('ayer')">‚è™ Ayer</button>
        <button class="btn-filtro btn-hoy" onclick="verCitas('hoy')">üìå Hoy</button>
        <button class="btn-filtro btn-manana" onclick="verCitas('manana')">‚è© Ma√±ana</button>
        <button class="btn-filtro" onclick="verCitas('mes')">üóìÔ∏è Mes</button>
        <button class="btn-filtro" onclick="verCitas('todos')">üìÇ Ver Todo</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Placa</th>
                <th>Servicio</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla">
            <tr><td colspan="4">Selecciona un filtro para ver citas...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // --- L√ìGICA PARA GUARDAR OT ---
    document.getElementById('otForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const status = document.getElementById('otStatus');
        const btn = document.getElementById('btnGuardarOT');
        
        btn.disabled = true;
        status.innerText = "‚è≥ Guardando...";

        const datos = {
            placa: document.getElementById('otPlaca').value.toUpperCase(),
            km: document.getElementById('otKm').value,
            tecnico: document.getElementById('otTecnico').value,
            detalles: document.getElementById('otDetalles').value
        };

        try {
            // Usamos la misma API pero el Worker sabr√° que es una OT por los datos
            const res = await fetch('/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...datos, tipo: 'OT' }) 
            });

            if (res.ok) {
                status.innerHTML = "<b style='color:green'>‚úÖ OT Guardada correctamente.</b>";
                e.target.reset();
            } else {
                status.innerHTML = "<b style='color:red'>‚ùå Error al guardar la OT.</b>";
            }
        } catch (err) {
            status.innerHTML = "<b style='color:red'>‚ùå Error de conexi√≥n.</b>";
        }
        btn.disabled = false;
    });

    // --- L√ìGICA PARA VER CITAS ---
    async function verCitas(periodo) {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = "<tr><td colspan='4'>üîç Buscando...</td></tr>";

        try {
            const res = await fetch(`/api?periodo=${periodo}`);
            const datos = await res.json();

            cuerpo.innerHTML = "";

            if (datos.length === 0) {
                cuerpo.innerHTML = "<tr><td colspan='4'>No hay registros.</td></tr>";
                return;
            }

            datos.forEach(c => {
                const fila = `<tr>
                    <td>${c.fecha_cita}</td>
                    <td>${c.hora_cita}</td>
                    <td class="placa-resaltada">${c.placa}</td>
                    <td>${c.servicio}</td>
                </tr>`;
                cuerpo.innerHTML += fila;
            });
        } catch (err) {
            cuerpo.innerHTML = "<tr><td colspan='4' style='color:red;'>‚ùå Error al cargar datos.</td></tr>";
        }
    }

    // Cargar hoy por defecto
    document.addEventListener('DOMContentLoaded', () => verCitas('hoy'));
</script>

</body>
</html>
