<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Global Pro - Control Total</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 25px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ccc; border-radius: 6px; font-size: 16px; text-transform: uppercase; }
        .btn-accion { width: 100%; padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: white; }
        .btn-negro { background: #222; }
        .btn-azul { background: #0056b3; }
        
        /* Filtros de colores */
        .btn-filtro { padding: 10px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; flex: 1; }
        .pendientes { background: #f39c12; }
        .aprobadas { background: #27ae60; }
        .rechazadas { background: #c0392b; }
        .todas { background: #34495e; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #222; color: white; }
    </style>
</head>
<body>

    <h1 style="text-align: center;">‚öôÔ∏è SISTEMA GLOBAL PRO</h1>

    <div class="box">
        <h2>üîç CONSULTAR TRABAJOS PREVIOS</h2>
        <input type="text" id="buscHistorialPlaca" placeholder="PLACA DEL VEH√çCULO">
        <button onclick="consultarHistorial()" class="btn-accion btn-negro">VER HISTORIAL DE OT</button>
        <div id="resHistorial" style="margin-top:15px; display:none; padding:15px; border: 2px solid #eee; background: #fafafa;"></div>
    </div>

    <div class="box">
        <h2>üìù NUEVA ORDEN DE TRABAJO</h2>
        <form id="otForm">
            <input type="text" id="otPlaca" placeholder="PLACA" required>
            <input type="number" id="otKm" placeholder="KILOMETRAJE" required>
            <input type="text" id="otTecnico" placeholder="NOMBRE DEL T√âCNICO" required>
            <textarea id="otDetalles" placeholder="TRABAJO REALIZADO" rows="3" required></textarea>
            <button type="submit" class="btn-accion btn-azul">üíæ GUARDAR ORDEN DE TRABAJO</button>
        </form>
    </div>

    <div class="box">
        <h2>üìÖ AGENDA DE CITAS (FILTRAR POR ESTADO)</h2>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="verCitasPorEstado('Pendiente')" class="btn-filtro pendientes">PENDIENTES</button>
            <button onclick="verCitasPorEstado('Aceptada')" class="btn-filtro aprobadas">APROBADAS</button>
            <button onclick="verCitasPorEstado('Rechazada')" class="btn-filtro rechazadas">RECHAZADAS</button>
            <button onclick="verCitas('todos')" class="btn-filtro todas">VER TODAS</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Placa</th>
                    <th>WhatsApp</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="cuerpoTablaCitas"></tbody>
        </table>
    </div>

<script>
    // --- CONSULTAR HISTORIAL ---
    async function consultarHistorial() {
        const placa = document.getElementById('buscHistorialPlaca').value.toUpperCase().trim();
        const resDiv = document.getElementById('resHistorial');
        if(!placa) return;
        resDiv.style.display = "block";
        resDiv.innerHTML = "Buscando...";
        const res = await fetch(`/api?placa=${placa}&tipo=historial`);
        const datos = await res.json();
        resDiv.innerHTML = datos.length === 0 ? "Sin historial." : 
            datos.map(t => `<div><b>${t.fecha_hora}:</b> ${t.notas_exigibles} (KM: ${t.kilometraje})</div>`).join('');
    }

    // --- FILTRAR CITAS POR ESTADO ---
    async function verCitasPorEstado(estado) {
        const cuerpo = document.getElementById('cuerpoTablaCitas');
        cuerpo.innerHTML = "Cargando...";
        const res = await fetch(`/api?periodo=todos`); // Traemos todas
        const datos = await res.json();
        // Filtramos en el cliente para no complicar el cerebro
        const filtrados = datos.filter(d => d.estado === estado);
        dibujarTabla(filtrados);
    }

    async function verCitas(periodo) {
        const res = await fetch(`/api?periodo=${periodo}`);
        const datos = await res.json();
        dibujarTabla(datos);
    }

    function dibujarTabla(datos) {
        const cuerpo = document.getElementById('cuerpoTablaCitas');
        cuerpo.innerHTML = datos.map(c => {
            const linkWA = `https://wa.me/${c.whatsapp}?text=Hola! Cita aceptada para la placa ${c.placa}`;
            return `<tr>
                <td>${c.fecha_cita}</td>
                <td><b>${c.placa}</b></td>
                <td><a href="https://wa.me/${c.whatsapp}" target="_blank">WhatsApp</a></td>
                <td style="font-weight:bold; color:${c.estado==='Aceptada'?'green':(c.estado==='Rechazada'?'red':'orange')}">${c.estado}</td>
                <td>
                    <button onclick="cambiarEstado(${c.id}, 'Aceptada'); window.open('${linkWA}')">‚úîÔ∏è</button>
                    <button onclick="cambiarEstado(${c.id}, 'Rechazada')">‚ùå</button>
                </td>
            </tr>`;
        }).join('');
    }

    async function cambiarEstado(id, nuevoEstado) {
        await fetch('/api', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, nuevoEstado })
        });
        verCitas('todos');
    }

    document.getElementById('otForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            tipo: 'OT',
            placa: document.getElementById('otPlaca').value.toUpperCase().trim(),
            km: document.getElementById('otKm').value,
            tecnico: document.getElementById('otTecnico').value,
            detalles: document.getElementById('otDetalles').value
        };
        const res = await fetch('/api', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if(res.ok) { alert("OT Guardada"); e.target.reset(); }
    });

    document.addEventListener('DOMContentLoaded', () => verCitas('todos'));
</script>
</body>
</html>