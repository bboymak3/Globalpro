export interface Env {
  AI: any;
  DB: D1Database;
}

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);

    if (url.pathname === '/api/chat' && request.method === 'POST') {
      const { messages } = await request.json();

      // 1. Detectar placa en el mensaje
      const lastUserMessage = messages[messages.length - 1].content.toUpperCase();
      const placaMatch = lastUserMessage.match(/[A-Z0-9]{6,7}/); 

      let historialPrevio = "";

      if (placaMatch) {
        const placa = placaMatch[0];
        
        // 2. Consulta a D1: Buscamos en la tabla de Eventos (Visitas previas)
        const { results } = await env.DB.prepare(`
          SELECT e.fecha_hora, e.notas_exigibles, e.kilometraje, e.tecnico_nombre
          FROM Eventos e
          JOIN Clientes c ON c.id = e.cliente_id
          WHERE c.placa = ?
          ORDER BY e.id DESC LIMIT 3
        `).bind(placa).all();

        if (results && results.length > 0) {
          historialPrevio = `\n[DATOS REALES DEL TALLER para la placa ${placa}: ${JSON.stringify(results)}]`;
        } else {
          historialPrevio = `\n[SISTEMA: No existen registros de trabajos previos para la placa ${placa}]`;
        }
      }

      // 3. Instrucciones para que la IA use esos datos
      const systemPrompt = `Eres el asistente técnico de Global Pro Automotriz. 
      Tu misión es informar a los clientes sobre los trabajos realizados en sus vehículos.
      Si el sistema te entrega DATOS REALES DEL TALLER, resume los trabajos (qué se hizo, qué fecha y qué técnico) de forma profesional.
      Si no hay datos, invita al cliente a agendar su primera cita.
      Usa siempre un tono servicial y técnico. ${historialPrevio}`;

      // 4. Ejecución de la IA
      const response = await env.AI.run('@cf/meta/llama-3-8b-instruct', {
        messages: [
          { role: 'system', content: systemPrompt },
          ...messages
        ],
        stream: true,
      });

      return new Response(response, {
        headers: { 'content-type': 'text/event-stream' },
      });
    }

    return new Response("Not Found", { status: 404 });
  },
};
